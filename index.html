<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Väsenväktaren</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        /* Prevent flash on page load - hide all screens until JS initializes */
        body.loading .screen {
            display: none !important;
        }
    </style>
</head>
<body class="loading">
    <!-- SVG Filter for Zone Image Wave Effect -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" aria-hidden="true">
        <defs>
            <filter id="zone-wave-filter" x="-20%" y="-20%" width="140%" height="140%">
                <feTurbulence 
                    id="zone-turbulence" 
                    type="turbulence" 
                    baseFrequency="0.01 0.02" 
                    numOctaves="2" 
                    result="turbulence" 
                    seed="2">
                    <animate 
                        attributeName="baseFrequency" 
                        from="0.01 0.02" 
                        to="0.02 0.01" 
                        dur="8s" 
                        repeatCount="indefinite" 
                        calcMode="spline"
                        keySplines="0.4 0 0.6 1; 0.4 0 0.6 1"
                        keyTimes="0; 0.5; 1"
                        values="0.01 0.02; 0.02 0.01; 0.01 0.02"/>
                </feTurbulence>
                <feDisplacementMap 
                    in="SourceGraphic" 
                    in2="turbulence" 
                    scale="3" 
                    xChannelSelector="R" 
                    yChannelSelector="G"/>
            </filter>
        </defs>
    </svg>

    <!-- Message Container for Toasts -->
    <div id="message-container" class="message-container"></div>

    <!-- Persistent Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay"></div>

    <!-- Main Menu Screen -->
    <div id="main-menu-screen" class="screen active">
        <div class="main-menu-content">
            <h1 class="game-title">Väsenväktaren</h1>
            <p class="game-subtitle">Catch creatures of Swedish folklore</p>
            <div class="menu-buttons">
                <button id="new-game-btn" class="btn btn-primary">New Game</button>
            </div>
        </div>
    </div>

    <!-- Starter Selection Screen -->
<div id="starter-select-screen" class="screen">
  <div class="starter-content">
    <p class="starter-intro">You find yourself in a strange forest.</p>
    <p class="starter-prompt">Choose who to befriend:</p>
    <div id="starter-options" class="starter-options"></div>
    <button id="confirm-starter-btn" class="btn btn-primary" disabled>Confirm</button>
  </div>
</div>


    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <!-- Header -->
        <header class="game-header">
            <div class="header-left">
                <h1 class="header-title">Väsenväktaren</h1>
                <span class="header-subtitle">Catch creatures of Swedish folklore</span>
            </div>
            <div class="header-center">
                <div id="player-profile" class="player-profile">
                    <span id="player-name-display">Väktare</span>
                </div>
            </div>
            <div class="header-right">
                <button id="combat-tips-btn" class="btn btn-small">Game Guide</button>
                <button id="settings-btn" class="btn btn-small">Settings</button>
            </div>
        </header>

        <!-- Main Game Content -->
        <main class="game-main">
            <!-- Left Panel - Inventory -->
            <aside class="panel panel-left">
                <!-- Mobile Inventory Toggle Button -->
                <button id="inventory-toggle-btn" class="inventory-toggle-btn">
                    <span class="toggle-text">Hide Inventory</span>
                    <span class="toggle-icon">«</span>
                </button>
                
                <!-- Collapsible Inventory Container -->
                <div id="inventory-collapsible" class="inventory-collapsible">
                    <div class="panel-tabs">
                        <button id="tab-vasen" class="tab-btn active" data-tab="vasen">Väsen</button>
                        <button id="tab-runes" class="tab-btn" data-tab="runes">Runes</button>
                        <button id="tab-items" class="tab-btn" data-tab="items">Items</button>
                    </div>
                    <div class="panel-content">
                        <!-- Väsen Tab -->
                        <div id="inventory-vasen" class="tab-content active"></div>
                        <!-- Runes Tab -->
                        <div id="inventory-runes" class="tab-content"></div>
                        <!-- Items Tab -->
                        <div id="inventory-items" class="tab-content"></div>
                    </div>
                    <!-- Vasen Details Panel -->
                    <div id="vasen-details-panel" class="vasen-details-panel"></div>
                </div>
            </aside>

            <!-- Middle Panel - World & Party -->
            <section class="panel panel-middle">
                <div class="party-section">
                    <h3 class="section-title">Active Party</h3>
                    <div class="party-slots">
                        <div id="party-slot-0" class="party-slot" data-slot="0">
                            <span class="slot-label">Lead</span>
                            <div class="slot-content empty">Empty</div>
                        </div>
                        <div id="party-slot-1" class="party-slot" data-slot="1">
                            <span class="slot-label">Slot 2</span>
                            <div class="slot-content empty">Empty</div>
                        </div>
                        <div id="party-slot-2" class="party-slot" data-slot="2">
                            <span class="slot-label">Slot 3</span>
                            <div class="slot-content empty">Empty</div>
                        </div>
                    </div>
                </div>
                <div class="zone-section">
                    <h3 class="section-title">Zones</h3>
                    <div id="zone-list" class="zone-list"></div>
                    <div class="zone-actions">
                        <button id="explore-btn" class="btn btn-primary btn-large" disabled>Explore</button>
                        <button id="challenge-btn" class="btn btn-secondary" disabled>Challenge Guardian</button>
                    </div>
                </div>
            </section>

            <!-- Right Panel - Action/Combat Area -->
            <section class="panel panel-right">
                <div id="zone-description" class="zone-description">
                    <p class="no-zone-msg">Select a zone to begin exploring.</p>
                </div>
                <div id="combat-area" class="combat-area" style="display: none;">
                    <div id="combat-ui" class="combat-ui">
                        <div class="combat-arena">
                            <div id="player-panel" class="combatant-panel player-side"></div>
                            <div class="combat-versus">VS</div>
                            <div id="enemy-panel" class="combatant-panel enemy-side"></div>
                        </div>
                    </div>

                    <!-- Battle Log Toggle Button -->
                    <button id="battle-log-toggle-btn" class="battle-log-toggle-btn">
                        <span class="toggle-text">Hide Battle Log</span>
                        <span class="toggle-icon">«</span>
                    </button>

                    <!-- Collapsible Battle Log Container -->
                    <div id="battle-log-collapsible" class="battle-log-collapsible">
                        <div id="combat-log" class="combat-log"></div>
                    </div>

                    <div id="ability-buttons" class="ability-buttons"></div>
                    <div class="action-buttons">
                        <button id="btn-swap" class="btn btn-action">Swap</button>
                        <button id="btn-offer" class="btn btn-action">Offer Item</button>
                        <button id="btn-ask" class="btn btn-action">Ask About Item</button>
                        <button id="btn-pass" class="btn btn-action">Pass</button>
                        <button id="btn-surrender" class="btn btn-danger">Surrender</button>
                    </div>
                </div>
            </section>
        </main>

    </div>

    <!-- Modals -->
    
    <!-- Ally Selection Modal -->
    <div id="ally-select-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Target for <span id="ally-select-ability-name"></span></h3>
                <button id="close-ally-select-modal" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div id="ally-select-list"></div>
            </div>
        </div>
    </div>

    <!-- Swap Modal -->
<div id="swap-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Choose a Väsen to Swap In</h3>
            <button id="close-swap-modal" class="modal-close">×</button>
        </div>
        <div class="modal-body">
            <div id="swap-modal-list"></div>
        </div>
    </div>
</div>
    
    <!-- Dialogue Modal -->
    <div id="dialogue-modal" class="modal">
        <div class="modal-content modal-dialogue">
            <h3 id="dialogue-title" class="modal-title"></h3>
            <p id="dialogue-message" class="dialogue-message"></p>
            <div id="dialogue-buttons" class="dialogue-buttons"></div>
        </div>
    </div>

    <!-- Offer Item Modal -->
    <div id="offer-modal" class="modal">
        <div class="modal-content modal-offer">
            <h3 class="modal-title">Offer Item</h3>
            <div id="offer-item-list" class="offer-item-list"></div>
            <button id="close-offer-modal" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- Heal Väsen Modal -->
    <div id="heal-vasen-modal" class="modal">
        <div class="modal-content modal-heal">
            <h3 class="modal-title">Use Item to Heal</h3>
            <div id="heal-vasen-list" class="heal-vasen-list"></div>
            <button id="close-heal-modal" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- Rune Equip Modal -->
    <div id="rune-equip-modal" class="modal">
        <div class="modal-content modal-rune">
            <h3 class="modal-title">Equip Rune</h3>
            <div id="rune-equip-list" class="rune-equip-list"></div>
            <button id="close-rune-modal" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- Knockout Swap Modal -->
    <div id="knockout-swap-modal" class="modal">
        <div class="modal-content modal-swap">
            <h3 class="modal-title">Choose Next Väsen</h3>
            <p class="modal-subtitle">Your active Väsen was knocked out!</p>
            <div id="knockout-swap-list" class="swap-vasen-list"></div>
        </div>
    </div>

<!-- Rune Equip to Väsen Modal -->
<div id="rune-to-vasen-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Equip Rune to Väsen</h3>
            <button id="close-rune-to-vasen-modal" class="modal-close">×</button>
        </div>
        <div class="modal-body">
            <div id="rune-to-vasen-list"></div>
        </div>
    </div>
</div>

<!-- Add Väsen to Party Modal -->
<div id="add-vasen-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add Väsen to Party</h3>
            <button id="close-add-vasen-modal" class="modal-close">×</button>
        </div>
        <div class="modal-body">
            <div id="add-vasen-list"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
    <div class="modal-content modal-settings">
        <h3 class="modal-title">Settings</h3>

        <!-- Save Management -->
        <div class="settings-section">
            <h4>Save Management</h4>
            <p class="settings-note">Game auto-saves.</p>

            <div class="save-buttons">
                <button id="export-save-btn" class="btn btn-secondary">Export Save</button>
                <button id="import-save-btn" class="btn btn-secondary">Import Save</button>
            </div>

            <textarea id="import-save-data" class="import-textarea" 
                      placeholder="Paste save data here..." 
                      style="display: none;"></textarea>

            <button id="confirm-import-btn" class="btn btn-primary" style="display:none;">
                Import Now
            </button>

            <button id="reset-game-btn" class="btn btn-danger">Reset Game</button>
        </div>

        <!-- Credits Section -->
        <div class="settings-section">
            <h4>Credits</h4>
            <p>Developer: Mattias Milger</p>
            </p>
            <p>
                <a href="https://github.com/MattiasMilger/Vasenvaktaren" 
                   target="_blank" 
                   title="View source code and star the project on GitHub.">
                    GitHub Repository
                </a>
            </p>
        </div>

        <button id="close-settings" class="btn btn-secondary">Close</button>
    </div>
</div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content modal-profile">
            <h3 class="modal-title">Player Profile</h3>
            <div id="profile-content" class="profile-content">
                <!-- Profile content rendered by JS -->
            </div>
            <button id="change-name-btn" style="display: none;"></button>
            <button id="close-profile" class="btn btn-secondary">Close</button>
        </div>
    </div>

    <!-- Game Guide Modal -->
    <div id="combat-tips-modal" class="modal">
        <div class="modal-content modal-tips">
            <h3 class="modal-title">Game Guide</h3> <br>
            <div class="tips-content">
                <h4>Taming</h4>
                <p>Tame a Väsen by offering it its desired item, and then defeating it. Find out the desired item by carefully reading the description or asking the Väsen during combat. You can offer up to <span id="guide-max-offers"></span> items per combat.</p>

                <!-- Attributes Section -->
                <h4>Attributes</h4>
                <p><strong>Strength (STR)</strong> - increases damage with Strength attacks.<br>
                    <strong>Wisdom (WIS)</strong> - increases damage with Wisdom attacks.<br>
                    <strong>Defense (DEF)</strong> - Reduces damage from Strength attacks.<br>
                    <strong>Durability (DUR)</strong> - Reduces damage taken from Wisdom attacks.</p>
                
                <h4>Resources</h4>
                <p><strong>Health (HP)</strong> - At 0 the väsen is knocked out. Health persists between battles.<br>
                <strong>Megin (MP)</strong> - Used to perform abilities. Megin fully restores after each combat.</p>

                <!-- Dynamic Element Matchups Section -->
                <div id="dynamic-element-matchups"></div>

                <!-- Dynamic Families Section -->
                <div id="dynamic-families"></div>
                
                <!-- Dynamic Temperaments Section -->
                <div id="dynamic-temperaments"></div>

                <h4>Runes</h4>
                <p>Equip runes to your Väsen for powerful effects. At level <span id="guide-max-level-runes"></span>, they gain the ability to equip two runes.</p>

                <h4>Megin System</h4>
                <p><strong>Regeneration:</strong> <span id="guide-megin-regen"></span> of max Megin restored per turn<br>
                <strong>Same-Element Discount:</strong> Abilities aligned with the väsen's own element cost <span id="guide-element-discount"></span> less Megin<br>

                <h4>Healing</h4>
                <p><strong>Post-Battle:</strong> Active party heals <span id="guide-post-battle-heal"></span> of max HP (even from 0 HP)<br>
                <strong>Sacred Well:</strong> All Väsen (including those not in party) heal <span id="guide-sacred-well-heal"></span> of max HP<br>
                <strong>Items (Correct):</strong> Giving a Väsen its desired item heals <span id="guide-correct-item-heal"></span> of max HP<br>
                <strong>Items (Wrong):</strong> Giving a Väsen any other item heals <span id="guide-wrong-item-heal"></span> of max HP<br>
                <em>Note: All healing is based on max health, not current health.</em></p>

                <h4>Experience & Leveling</h4>
                <p><strong>Max Level:</strong> <span id="guide-max-level"></span><br>
                <strong>Distribution:</strong><br>
                - Killing Blow: <span id="guide-exp-killing"></span> of base experience<br>
                - Participated in Battle: <span id="guide-exp-participated"></span> of base experience<br>
                - In Party (not fielded): <span id="guide-exp-party"></span> of base experience<br>
                - Knocked Out: 0% (no experience)<br>
                <em>Experience is only awarded after combat ends.</em></p>

                <h4>Power</h4>
                <p>Power is a value shown on each ability that represents the basic damage multiplier, which is scaled by the associated damage attribute (Strength/Wisdom). Damage has a variance of ±<span id="guide-damage-variance"></span>.</p>

                <h4>Attribute Stages</h4>
                <p>Some abilities and runes raise or lower attribute stages. Each stage increases or decreases the affected attribute by <span id="guide-stage-modifier"></span>. Stages range from <span id="guide-min-stage"></span> to <span id="guide-max-stage"></span>. Attribute stages reset after battle (except in Endless Tower where they persist between floors).</p>

                <h4>Move Priority</h4>
                <p>Swapping > Utility Moves > Attack moves. Player has priority and acts first.</p>

                <h4>Endless Tower</h4>
                <p>Challenge the Endless Tower in Ginnungagap starting at level <span id="guide-endless-start"></span>. Attribute stages persist between floors. Post-floor healing: <span id="guide-endless-heal"></span> of max HP.</p>
            </div>
            <button id="close-combat-tips" class="btn btn-primary">Close</button>
        </div>
    </div>

    <!-- Scripts loaded in dependency order -->
    
    <!-- Core Data & Logic -->
    <script src="js/core/1-constants.js"></script>
    <script src="js/core/2-data-abilities.js"></script>
    <script src="js/core/3-data-vasen.js"></script>
    <script src="js/core/4-data-items.js"></script>
    <script src="js/core/5-vasen-instance.js"></script>
    
    <!-- Game Systems -->
    <script src="js/systems/6a-battle-core.js"></script>
    <script src="js/systems/6b-battle-ai.js"></script>
    <script src="js/systems/7-game-state.js"></script>
    
    <!-- UI Controller -->
    <script src="js/8-ui-controller.js"></script>
    
    <!-- Main Entry Point -->
    <script src="js/9-main.js"></script>
</body>
</html>
